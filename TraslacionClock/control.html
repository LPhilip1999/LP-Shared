<!DOCTYPE html>
<html lang="en">
<head>
    <title>Traslacion 2026 Manual Controller</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        #protected-content { display: none; }
        body { font-family: sans-serif; text-align: center; padding: 30px; background: #1a1a1a; color: white; }
        .control-box { background: #333; padding: 20px; border-radius: 10px; display: inline-block; }
        input[type="datetime-local"] { font-size: 18px; padding: 10px; margin: 10px; border-radius: 5px; }
        button { font-size: 18px; padding: 12px 25px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-set { background: #007bff; color: white; }
        .btn-pause { background: #fd7e14; color: white; }
        .btn-stop { background: #dc3545; color: white; }
        .btn-reset { background: #6c757d; color: white; }
        .status { margin: 15px; font-size: 1.2em; color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div id="protected-content">
        <h1>Traslacion 2026 Manual Entry</h1>
        <div class="control-box">
            <p>Enter the Exact Start Time of the Procession:</p>
            <input type="datetime-local" id="startTimeInput">
            <br>
            <button class="btn-set" onclick="startManualTimer()">SYNC & START</button>
            <button id="pauseResumeBtn" class="btn-pause" onclick="togglePause()">PAUSE</button>
            <button class="btn-stop" onclick="stopTimer()">STOP/FREEZE</button>
            <button class="btn-reset" onclick="resetToZero()">RESET TO ZERO</button>
        </div>
        <div class="status" id="status">Connecting to Cloud...</div>
        <h2 id="localDisplay">00:00:00</h2>
    </div>

    <script>
        // --- FIREBASE INITIALIZATION ---
        // !!! REPLACE WITH YOUR ACTUAL FIREBASE CONFIG !!!
        const firebaseConfig = {
            apiKey: "AIzaSyChe-th-e1RQJGnRxdIcpKgJ2AuIsILjTQ",
            authDomain: "traslacion-clock-2026.firebaseapp.com",
            databaseURL: "https://traslacion-clock-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "traslacion-clock-2026",
            storageBucket: "traslacion-clock-2026.firebasestorage.app",
            appId: "1:506370432562:web:3ae603fce823dfa59ba62b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- PASSCODE PROTECTION ---
        const passcode = "2026"; 
        const userEntry = prompt("Enter passcode to access timer controls:");
        if (userEntry === passcode) {
            document.getElementById('protected-content').style.display = 'block';
        } else {
            alert("Incorrect passcode.");
            document.body.innerHTML = "<h1>Unauthorized Access</h1>";
        }

        const startTimeInput = document.getElementById('startTimeInput');
        const statusDiv = document.getElementById('status');
        const pauseBtn = document.getElementById('pauseResumeBtn');
        let currentIsPaused = false;
        let localInterval = null;

        // --- CLOUD LISTENER ---
        db.ref('traslacion').on('value', (snapshot) => {
            const data = snapshot.val();
            if (localInterval) clearInterval(localInterval);
            
            if (data && data.isRunning) {
                currentIsPaused = data.isPaused || false;
                pauseBtn.innerText = currentIsPaused ? "RESUME" : "PAUSE";
                statusDiv.innerText = currentIsPaused ? "Status: PAUSED" : "Status: LIVE";
                startTimeInput.value = data.savedInput || "";

                localInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const refTime = currentIsPaused ? data.pauseTime : now;
                    let diff = Math.floor((refTime - data.startTime) / 1000);
                    updateLocalDisplay(diff < 0 ? 0 : diff);
                }, 1000);
            } else {
                statusDiv.innerText = "Status: Idle";
                updateLocalDisplay(0);
            }
        });

        function startManualTimer() {
            const inputVal = startTimeInput.value;
            if (!inputVal) return alert("Select time!");
            const startTimeMs = new Date(inputVal).getTime();
            
            db.ref('traslacion').set({
                startTime: startTimeMs,
                isRunning: true,
                isPaused: false,
                savedInput: inputVal
            });
        }

        function togglePause() {
            const now = new Date().getTime();
            db.ref('traslacion').once('value').then(snap => {
                const data = snap.val();
                if (!data || !data.isRunning) return;

                if (!currentIsPaused) {
                    db.ref('traslacion').update({ isPaused: true, pauseTime: now });
                } else {
                    const pauseDuration = now - data.pauseTime;
                    db.ref('traslacion').update({
                        isPaused: false,
                        startTime: data.startTime + pauseDuration,
                        pauseTime: null
                    });
                }
            });
        }

        function stopTimer() {
            db.ref('traslacion/isRunning').set(false);
        }

        function resetToZero() {
            db.ref('traslacion').set({ startTime: 0, isRunning: false, isPaused: false });
        }

        function updateLocalDisplay(totalSeconds) {
            const hrs = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const secs = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('localDisplay').innerText = `${hrs}:${mins}:${secs}`;
        }
    </script>
</body>
</html>
